# 多字符串查询

`bool` 查询采取 *more-matches-is-better* 匹配越多越好的方式，所以每条 `match` 语句的评分结果会被加在一起，从而为每个文档提供最终的分数 `_score` 。

当然，并不是只能使用 `match` 语句：可以用 `bool` 查询来包裹组合任意其他类型的查询， 甚至包括其他的 `bool` 查询。

## 语句的优先级

 `boost` 参数：

```
GET /_search
{
  "query": {
    "bool": {
      "should": [
        { "match": { 
            "title":  {
              "query": "War and Peace",
              "boost": 2
        }}},
        { "match": { 
            "author":  {
              "query": "Leo Tolstoy",
              "boost": 2
        }}},
        { "bool":  { 
            "should": [
              { "match": { "translator": "Constance Garnett" }},
              { "match": { "translator": "Louise Maude"      }}
            ]
        }}
      ]
    }
  }
}
```



# 单字符查询

当用户输入了单个字符串查询的时候，通常会遇到以下三种情形：

- 最佳字段

  当搜索词语具体概念的时候，比如 “brown fox” ，词组比各自独立的单词更有意义。像 `title` 和 `body` 这样的字段，尽管它们之间是相关的，但同时又彼此相互竞争。文档在 *相同字段* 中包含的词越多越好，评分也来自于 *最匹配字段* 。

- 多数字段

  为了对相关度进行微调，常用的一个技术就是将相同的数据索引到不同的字段，它们各自具有独立的分析链。

  主字段可能包括它们的词源、同义词以及 *变音词* 或口音词，被用来匹配尽可能多的文档。

  相同的文本被索引到其他字段，以提供更精确的匹配。一个字段可以包括未经词干提取过的原词，另一个字段包括其他词源、口音，还有一个字段可以提供 [词语相似性](http://elasticsearch.cn/book/elasticsearch_definitive_guide_2.x/proximity-matching.html) 信息的瓦片词（shingles）。

  其他字段是作为匹配每个文档时提高相关度评分的 *信号* ， *匹配字段越多* 则越好。

- 混合字段

  对于某些实体，我们需要在多个字段中确定其信息，单个字段都只能作为整体的一部分：

  - Person： `first_name` 和 `last_name` （人：名和姓）

  - Book： `title` 、 `author` 和 `description` （书：标题、作者、描述）

  - Address： `street` 、 `city` 、 `country` 和 `postcode` （地址：街道、市、国家和邮政编码）

  在这种情况下，我们希望在 *任何* 这些列出的字段中找到尽可能多的词，这有如在一个大字段中进行搜索，这个大字段包括了所有列出的字段。



# 最佳字段

使用 `dis_max` 即分离 *最大化查询（Disjunction Max Query）* 。分离（Disjunction）的意思是 *或（or）* ，这与可以把结合（conjunction）理解成 *与（and）* 相对应。分离最大化查询（Disjunction Max Query）指的是： *将任何与任一查询匹配的文档作为结果返回，但只将最佳匹配的评分作为查询的评分结果返回* ：

```
{
    "query": {
        "dis_max": {
            "queries": [
                { "match": { "title": "Brown fox" }},
                { "match": { "body":  "Brown fox" }}
            ]
        }
    }
}
```

# 最佳字段调优

通过指定 `tie_breaker` 这个参数将其他匹配语句的评分也考虑其中：

```
{
    "query": {
        "dis_max": {
            "queries": [
                { "match": { "title": "Quick pets" }},
                { "match": { "body":  "Quick pets" }}
            ],
            "tie_breaker": 0.3
        }
    }
}
```

`tie_breaker` 参数提供了一种 `dis_max` 和 `bool` 之间的折中选择，它的评分方式如下：

1. 获得最佳匹配语句的评分 `_score` 。
2. 将其他匹配语句的评分结果与 `tie_breaker` 相乘。
3. 对以上评分求和并规范化。

